# 數位化兵棋部署與沙盤推演系統
## 專案企劃書

**版本：** v2.0
**類型：** 專業軍事模擬 / 輔助決策工具
**核心目標：** 建立一套視覺化、標準化的 3D 兵棋沙盤，實現戰鬥序列（ORBAT）的數位化管理，並達成兵棋符號與 3D 實體模型的無縫聯動。

---

## 一、系統概述

### 1.1 專案背景

傳統兵棋推演依賴實體沙盤與紙質地圖，存在以下痛點：
- 單位部署耗時，調整困難
- 缺乏三維地形視角，掩蔽判定主觀
- 戰術標繪不易修改
- 無法保存與快速重現場景
- 多人協作需在同一物理空間

本系統旨在透過數位化技術解決上述問題，提供直觀、靈活、標準化的推演環境。

### 1.2 系統目標

| 目標類別 | 具體描述 |
|---------|---------|
| **標準化** | 採用 APP-6D / MIL-STD-2525 標準符號系統 |
| **視覺化** | 3D 地形與模型，支援多視角切換 |
| **可編輯** | 拖拽式部署，即時調整單位位置與屬性 |
| **可擴展** | 模組化架構，支援自訂單位與地圖 |
| **可協作** | 支援多人聯機推演（未來擴展） |

### 1.3 目標使用者

- 軍事教育訓練機構
- 參謀人員（作戰計畫擬定）
- 兵棋推演愛好者
- 國防研究單位

---

## 二、系統架構

### 2.1 整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                      使用者介面層 (UI Layer)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │  工具列  │  │ 屬性面板 │  │ ORBAT樹  │  │ 時間軸  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
├─────────────────────────────────────────────────────────────┤
│                    應用程式層 (Application Layer)             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │            狀態管理器 (State Manager)                 │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │ ORBAT狀態│  │ 場景狀態 │  │ UI狀態   │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └──────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                      領域層 (Domain Layer)                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ ORBAT模組│  │符號引擎  │  │ 地形系統 │  │ 戰術標繪 │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
├─────────────────────────────────────────────────────────────┤
│                   基礎設施層 (Infrastructure Layer)           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Three.js 核心 (渲染引擎)                  │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │ 場景管理 │  │ 攝影機   │  │ 渲染循環 │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心模組說明

#### 模組一：組織管理模組 (ORBAT Manager)

**功能描述：** 管理部隊層級結構與單位屬性

**詳細功能：**

| 子功能 | 描述 |
|-------|------|
| 層級編輯器 | 樹狀結構顯示，支援拖曳調整父子關係 |
| SIDC 選擇器 | 圖形化介面選擇 20 碼符號代碼 |
| 單位屬性面板 | 編輯名稱、編制、狀態等屬性 |
| 模型綁定 | 關聯 3D 模型檔案 |
| 批次操作 | 多選單位進行批次修改或移除 |

**資料結構：**

```typescript
interface ORBATNode {
  uuid: string;           // 唯一識別碼
  name: string;           // 單位名稱
  parentId: string | null; // 父節點 ID
  children: string[];     // 子節點 ID 列表
  level: UnitLevel;       // 層級等級
  sidc: string;           // 20碼符號代碼
  modelId: string | null; // 3D模型ID
  properties: UnitProperties; // 單位屬性
}

enum UnitLevel {
  ARMY = 'army',          // 軍團
  CORPS = 'corps',        // 軍
  DIVISION = 'division',  // 師
  BRIGADE = 'brigade',    // 旅
  BATTALION = 'battalion',// 營
  COMPANY = 'company',    // 連
  PLATOON = 'platoon',    // 排
  SQUAD = 'squad'         // 班
}

interface UnitProperties {
  commander: string;      // 指揮官姓名
  strength: number;       // 實兵人數
  equipment: Equipment[]; // 裝備清單
  status: UnitStatus;     // 當前狀態
  notes: string;          // 備註
}
```

#### 模組二：符號生成引擎 (Symbol Engine)

**功能描述：** 將 SIDC 代碼轉換為標準軍規符號圖像

**詳細功能：**

| 子功能 | 描述 |
|-------|------|
| SIDC 解析 | 解析 20 碼代碼各欄位含義 |
| 符號繪製 | 依據標準繪制框架、圖標、修飾符 |
| 動態貼圖 | 生成 Three.js 可用材質 |
| 狀態疊加 | 疊加文字標籤、狀態條 |
| 快取管理 | 快取已生成符號，提升效能 |

**SIDC 代碼結構解析：**

```
位置:  1    2    3    4-5    6-10     11-14    15-17    18-20
範例:  3    0    0    31     00015    1211     000      20

欄位說明:
┌─────┬─────────┬────────────────────────────────────────┐
│位置 │ 名稱    │ 說明                                   │
├─────┼─────────┼────────────────────────────────────────┤
│ 1   │ 標準版本│ 3=MIL-STD-2525D,  其他=APP-6D         │
│ 2   │ 身份    │ 0=友軍, 1=敵軍, 2=中立, 3=未知         │
│ 3   │ 戰鬥態樣│ 0=現實, 1=演習, 2=模擬                 │
│ 4-5 │ 領域    │ 10=陸戰, 30=空戰, 50=海戰             │
│ 6-10│ 實體類型│ 00015=裝甲, 00010=步兵...              │
│ 11-14│ 特定類型│ 細分單位類型                           │
│ 15-17│ 修飾符  │ 特殊標記                               │
│ 18-20│ 狀態    │ 作業狀態                               │
└─────┴─────────┴────────────────────────────────────────┘
```

**輸出格式：**

```typescript
interface SymbolTexture {
  uuid: string;           // 符號唯一ID
  sidc: string;           // 原始SIDC
  canvas: HTMLCanvasElement; // Canvas元素
  dataURL: string;        // Base64圖像
  size: { width: number; height: number };
  material: SpriteMaterial | MeshBasicMaterial; // Three.js材質
}
```

#### 模組三：三維沙盤模組 (3D Sand Table)

**功能描述：** 提供 3D 地形渲染與單位視覺化

**詳細功能：**

| 子功能 | 描述 |
|-------|------|
| 地形載入 | 支援 Heightmap / DEM 數據 |
| 材質貼圖 | 衛星圖像貼合地形 |
| 水體系統 | 海平面、河流、湖泊 |
| LOD 視圖 | 依距離切換顯示模式 |
| 攝影機控制 | 軌道控制、鍵盤導航 |
| 光照系統 | 日夜循環、動態陰影 |
| 天氣效果 | 霧、雨、雪（可選） |

**LOD 系統規格：**

```typescript
interface LODConfig {
  level: LODLevel;
  minDistance: number;    // 最小距離（公尺）
  maxDistance: number;    // 最大距離（公尺）
  display: LODDisplay;    // 顯示模式
}

enum LODLevel {
  STRATEGIC = 'strategic',   // 戰略視圖 (>500m)
  OPERATIONAL = 'operational', // 作戰視圖 (200-500m)
  TACTICAL = 'tactical',     // 戰術視圖 (50-200m)
  DETAIL = 'detail'          // 詳細視圖 (<50m)
}

interface LODDisplay {
  showModel: boolean;        // 顯示3D模型
  showSymbol: boolean;       // 顯示符號
  showLabel: boolean;        // 顯示標籤
  modelDetail: 'low' | 'medium' | 'high'; // 模型細節
  symbolSize: number;        // 符號大小（像素）
}
```

**預設 LOD 配置：**

```typescript
const DEFAULT_LOD_LEVELS: LODConfig[] = [
  {
    level: LODLevel.STRATEGIC,
    minDistance: 500,
    maxDistance: Infinity,
    display: {
      showModel: false,
      showSymbol: true,
      showLabel: false,
      modelDetail: 'low',
      symbolSize: 32
    }
  },
  {
    level: LODLevel.OPERATIONAL,
    minDistance: 200,
    maxDistance: 500,
    display: {
      showModel: false,
      showSymbol: true,
      showLabel: true,
      modelDetail: 'low',
      symbolSize: 48
    }
  },
  {
    level: LODLevel.TACTICAL,
    minDistance: 50,
    maxDistance: 200,
    display: {
      showModel: true,
      showSymbol: true,
      showLabel: true,
      modelDetail: 'low',
      symbolSize: 32
    }
  },
  {
    level: LODLevel.DETAIL,
    minDistance: 0,
    maxDistance: 50,
    display: {
      showModel: true,
      showSymbol: true,
      showLabel: true,
      modelDetail: 'high',
      symbolSize: 24
    }
  }
];
```

#### 模組四：戰術標繪模組 (Tactical Plotting)

**功能描述：** 在 3D 沙盤上繪製戰術圖形

**詳細功能：**

| 子功能 | 描述 |
|-------|------|
| 點位標記 | 集結地、目標點、檢查點 |
| 路線繪製 | 前進軸線、撤退路線、邊界線 |
| 區域標示 | 禁航區、交戰區、雷區 |
| 地形貼合 | 自動吸附地形高度 |
| 樣式設定 | 顏色、寬度、線型、箭頭 |
| 圖層管理 | 顯示/隱藏不同類型標繪 |

**戰術圖形資料結構：**

```typescript
interface TacticalGraphic {
  uuid: string;
  type: GraphicType;
  name: string;
  style: GraphicStyle;
  geometry: GraphicGeometry;
  metadata: Record<string, any>;
}

enum GraphicType {
  POINT = 'point',
  LINE = 'line',
  AREA = 'area',
  ARROW = 'arrow',
  TEXT = 'text'
}

interface GraphicStyle {
  color: string;          // #RRGGBB
  opacity: number;        // 0-1
  lineWidth: number;      // 像素
  lineDash?: number[];    // 虛線樣式 [實線長度, 空白長度]
  fill?: boolean;         // 填充
  showLabel?: boolean;    // 顯示標籤
}

interface GraphicGeometry {
  // 點位
  position?: Vector3;

  // 線條
  points?: Vector3[];

  // 區域
  vertices?: Vector3[];
}
```

#### 模組五：部署系統 (Deployment System)

**功能描述：** 將單位從 ORBAT 樹拖曳至 3D 場景

**詳細功能：**

| 子功能 | 描述 |
|-------|------|
| 拖拽部署 | 從樹狀圖拖曳單位至地圖 |
| 預覽模式 | 拖曳時顯示單位預覽 |
| 地形偵測 | 射線檢測地形高度 |
| 位置吸附 | 自動對齊網格（可選） |
| 批次部署 | 選擇多個單位批次放置 |
| 陣型部署 | 按預設陣型自動排列 |

**部署流程：**

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ 點擊單位 │ ──▶ │ 開始拖曳 │ ──▶ │ 預覽位置 │ ──▶ │ 放置完成 │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
                   │                │                │
                   ▼                ▼                ▼
              ┌─────────┐     ┌─────────┐     ┌─────────┐
              │ 游標變更 │     │ 射線偵測 │     │ 更新狀態 │
              │ 為符號   │     │ 地形高度 │     │ 寫入座標 │
              └─────────┘     └─────────┘     └─────────┘
```

#### 模組六：時間控制模組 (Time Control)

**功能描述：** 控制推演時間流與回放

**詳細功能：**

| 子功能 | 描述 |
|-------|------|
| 播放控制 | 播放、暫停、停止 |
| 速度調整 | 0.5x, 1x, 2x, 4x |
| 時間軸 | 拖曳跳轉至指定時間 |
| 關鍵幀 | 記錄重要時間點 |
| 軌跡回放 | 單位移動路徑回放 |

#### 模組七：場景管理模組 (Scene Manager)

**功能描述：** 場景的保存、載入、匯出

**詳細功能：**

| 子功能 | 描述 |
|-------|------|
| 場景保存 | 將當前狀態序列化為 JSON |
| 場景載入 | 從 JSON 還原場景 |
| 快照功能 | 保存場景快照 |
| 版本管理 | 場景版本歷史 |
| 匯入匯出 | 支援多種檔案格式 |

---

## 三、使用者介面設計

### 3.1 介面佈局

```
┌─────────────────────────────────────────────────────────────┐
│  [功能表]  [編輯]  [檢視]  [工具]  [說明]        [設定] [?]  │ 選單列
├──────┬──────────────────────────────────────────────────────┤
│ 工具 │ ┌──────────────────────────────────────────────────┐ │
│ 內容 │ │                                                    │ │
│      │ │                   3D 沙盤場景                      │ │
│      │ │                                                    │ │
│      │ │                                                    │ │
│      │ │                                                    │ │
│      │ └──────────────────────────────────────────────────┘ │
├──────┴──────────────────────────────────────────────────────┤
│ [時間軸: █━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━] [播放][暫停]      │ 時間軸
└─────────────────────────────────────────────────────────────┘
```

### 3.2 面板說明

#### 左側工具面板

```
┌─────────────────┐
│   單位庫        │
├─────────────────┤
│ □ ORBAT 編輯器  │
│ □ 單位清單      │
│ □ 模型瀏覽器    │
│ □ 戰術標繪      │
└─────────────────┘
```

#### 右側屬性面板

```
┌─────────────────┐
│   單位屬性      │
├─────────────────┤
│ 名稱: [第1營]   │
│ SIDC: [選擇...] │
│ 模型: [M1A2...] │
│ 位置: [120, 45] │
│ 方向: [0°]      │
│                 │
│ [狀態] [移動]   │
│ [刪除] [複製]   │
└─────────────────┘
```

### 3.3 快捷鍵定義

| 快捷鍵 | 功能 |
|-------|------|
| `Space` | 播放/暫停 |
| `Delete` | 刪除選中單位 |
| `Ctrl+Z` | 復原 |
| `Ctrl+Y` | 重做 |
| `Ctrl+S` | 儲存場景 |
| `Ctrl+O` | 開啟場景 |
| `F` | 聚焦選中單位 |
| `Esc` | 取消選擇 |
| `Tab` | 切換 LOD 模式 |
| `1-5` | 切換工具 |
| `+/-` | 縮放地圖 |
| `WASD` | 移動攝影機 |
| `Q/E` | 旋轉攝影機 |

---

## 四、技術規格

### 4.1 技術堆疊

| 類別 | 技術選擇 | 說明 |
|------|---------|------|
| 前端框架 | Vue 3 | 響應式 UI 框架 |
| 3D 引擎 | Three.js r160+ | WebGL 3D 渲染 |
| 狀態管理 | Pinia | Vue 3 原生狀態管理 |
| 符號生成 | milsymbol.js | APP-6D/MIL-STD-2525 符號 |
| 地理計算 | Turf.js | 空間分析運算 |
| 數學運算 | gl-matrix | 向量與矩陣運算 |
| 建置工具 | Vite | 快速開發建置工具 |
| 型別檢查 | TypeScript | 型別安全 |
| 程式碼規範 | ESLint + Prettier | 程式碼格式化 |

### 4.2 瀏覽器支援

| 瀏覽器 | 最低版本 |
|-------|---------|
| Chrome | 90+ |
| Firefox | 88+ |
| Edge | 90+ |
| Safari | 14+ |

### 4.3 效能目標

| 指標 | 目標值 |
|------|-------|
| 初始載入時間 | < 3 秒 |
| 幀率 (FPS) | ≥ 60 |
| 同場景單位數 | ≥ 1000 |
| 記憶體使用 | < 2GB |
| 地形載入時間 | < 5 秒 |

---

## 五、資料規格

詳細資料結構定義請參考 [`01-資料結構規格.md`](./01-資料結構規格.md)

---

## 六、開發優先順序

1. **階段一：基礎框架**
   - 專案腳手架
   - Three.js 場景初始化
   - 基礎 UI 佈局

2. **階段二：ORBAT 與符號**
   - 樹狀編輯器
   - 符號生成引擎
   - 符號顯示

3. **階段三：3D 沙盤**
   - 地形系統
   - 模型載入
   - LOD 系統

4. **階段四：部署與編輯**
   - 拖拽部署
   - 屬性編輯
   - 戰術標繪

5. **階段五：高級功能**
   - 時間控制
   - 場景管理
   - 匯入匯出

---

## 七、專案結構

```
Wargaming/
├── docs/                    # 文件目錄
│   ├── 00-專案企劃書.md
│   ├── 01-資料結構規格.md
│   └── 02-技術架構.md
├── public/                  # 公開資源
│   ├── assets/
│   │   ├── models/          # 3D 模型 (GLB/GLTF)
│   │   ├── textures/        # 貼圖
│   │   └── icons/           # 圖示
│   └── styles/              # 全域樣式
├── src/
│   ├── core/                # 核心系統
│   │   ├── SceneManager.ts  # 場景管理器
│   │   ├── CameraController.ts
│   │   └── Renderer.ts
│   ├── modules/             # 功能模組
│   │   ├── orbat/           # ORBAT 模組
│   │   ├── symbol/          # 符號引擎
│   │   ├── terrain/         # 地形系統
│   │   ├── tactical/        # 戰術標繪
│   │   └── deployment/      # 部署系統
│   ├── utils/               # 工具函數
│   ├── types/               # 型別定義
│   └── main.ts              # 程式進入點
└── package.json
```

---

*文件版本：v2.0*
*最後更新：2024-12-27*
